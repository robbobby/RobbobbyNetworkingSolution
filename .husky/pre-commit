#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

echo "üìù Formatting C# files..."
# Safe whitespace across the whole repo (tests included, no analyzer code fixes):
dotnet format whitespace --no-restore --verbosity minimal
# Analyzer fixes only for non-test projects:
for p in Serializer.Abstractions Serializer.Generator Serializer.Runtime Serializer.Wire Transport.Client Transport.Server Unity.Package; do
  dotnet format analyzers "$p" --no-restore --verbosity minimal
done

# Ensure formatting changes are included in this commit
echo "üì¶ Staging formatting changes..."
git add -u

echo "üî® Building solution..."
dotnet build

# Run unit tests
echo "üß™ Running unit tests..."
if out="$(dotnet test --filter "Category=Unit" --verbosity minimal 2>&1)"; then
    echo "$out"
    echo "‚úÖ Unit tests completed successfully!"
else
    echo "$out"
    if printf '%s' "$out" | grep -qiE 'No test is available'; then
        echo "‚ö†Ô∏è  No unit tests found - continuing with commit"
    else
        echo "‚ö†Ô∏è  Unit tests failed - continuing (pre-commit is non-blocking)"
    fi
fi

echo "‚úÖ Pre-commit checks completed successfully!"
