#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🔍 Running pre-commit checks..."

echo "📝 Formatting C# files..."
# Safe whitespace across the whole repo (tests included, no analyzer code fixes):
#dotnet format whitespace --no-restore --verbosity minimal || echo "⚠️  Formatting failed - continuing anyway"

# Analyzer fixes only for non-test projects:
#for p in Serializer.Abstractions Serializer.Generator Serializer.Runtime Serializer.Wire Transport.Client Transport.Server Unity.Package; do
#  dotnet format analyzers "$p" --no-restore --verbosity minimal || echo "⚠️  Analyzer formatting for $p failed - continuing anyway"
#done

# Ensure formatting changes are included in this commit
echo "📦 Staging formatting changes..."
git add -u

echo "🔨 Building solution..."
dotnet build || echo "⚠️  Build failed - continuing anyway"

# Run unit tests
echo "🧪 Running unit tests..."
dotnet test --filter "Category=Unit" --verbosity minimal || echo "⚠️  Unit tests failed - continuing anyway"

echo "✅ Pre-commit checks completed - proceeding with commit"
