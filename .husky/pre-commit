#!/usr/bin/env bash
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

echo "ğŸ“ Formatting C# files..."
#if ! dotnet format whitespace --no-restore --verbosity minimal; then
#    echo "âš ï¸  Formatting failed"
#    echo -n "Continue with commit anyway? (y/n): "
#    read -r REPLY < /dev/tty
#    if [[ ! "$REPLY" =~ ^[Yy]$ ]]; then
#        echo "âŒ Commit aborted"
#        exit 1
#    fi
#fi
#
## Analyzer fixes only for non-test projects:
#for p in Serializer.Abstractions Serializer.Generator Serializer.Runtime Serializer.Wire Transport.Client Transport.Server Unity.Package; do
#  if ! dotnet format analyzers "$p" --no-restore --verbosity minimal; then
#    echo "âš ï¸  Analyzer formatting for $p failed"
#    echo -n "Continue with commit anyway? (y/n): "
#    read -r REPLY < /dev/tty
#    if [[ ! "$REPLY" =~ ^[Yy]$ ]]; then
#        echo "âŒ Commit aborted"
#        exit 1
#    fi
#  fi
#done

# Ensure formatting changes are included in this commit
echo "ğŸ“¦ Staging formatting changes..."
#git add -u

echo "ğŸ”¨ Building solution..."
if ! dotnet build; then
    echo "âš ï¸  Build failed"
    echo -n "Continue with commit anyway? (y/n): "
    read -r REPLY < /dev/tty
    if [[ ! "$REPLY" =~ ^[Yy]$ ]]; then
        echo "âŒ Commit aborted"
        exit 1
    fi
fi

# Run unit tests
echo "ğŸ§ª Running unit tests..."
if ! dotnet test --filter "Category=Unit" --verbosity minimal; then
    echo "âš ï¸  Unit tests failed"
    echo -n "Continue with commit anyway? (y/n): "
    read -r REPLY < /dev/tty
    if [[ ! "$REPLY" =~ ^[Yy]$ ]]; then
        echo "âŒ Commit aborted"
        exit 1
    fi
fi

echo "âœ… Pre-commit checks completed - proceeding with commit"
