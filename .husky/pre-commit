#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

echo "üìù Formatting C# files (excluding test projects)..."
# Only format non-test projects to avoid xUnit analyzer auto-fixing issues
dotnet format Serializer.Abstractions --no-restore --verbosity minimal
dotnet format Serializer.Generator --no-restore --verbosity minimal
dotnet format Serializer.Runtime --no-restore --verbosity minimal
dotnet format Serializer.Wire --no-restore --verbosity minimal
dotnet format Transport.Client --no-restore --verbosity minimal
dotnet format Transport.Server --no-restore --verbosity minimal
dotnet format Unity.Package --no-restore --verbosity minimal

echo "üî® Building solution..."
dotnet build

# Run unit tests
echo "üß™ Running unit tests..."
if out="$(dotnet test --filter "Category=Unit" --verbosity minimal 2>&1)"; then
    echo "$out"
    echo "‚úÖ Unit tests completed successfully!"
else
    echo "$out"
    if printf '%s' "$out" | grep -qiE 'No test is available'; then
        echo "‚ö†Ô∏è  No unit tests found - continuing with commit"
    else
        echo "‚ö†Ô∏è  Unit tests failed - continuing (pre-commit is non-blocking)"
    fi
fi

echo "‚úÖ Pre-commit checks completed successfully!"
